<!-- Contenedor principal estilo Figma -->
<div class="figma-editor-container" [class.fullscreen-mode]="isFullscreen">
  <!-- Barra de herramientas superior flotante -->
  <div class="floating-toolbar">
    <div class="toolbar-left">
      <h5 class="toolbar-title mb-0">
        <i class="bi bi-diagram-3 me-2"></i>
        Editor de Flujo SAP
      </h5>
    </div>
    <div class="toolbar-right">
      <button class="btn btn-sm btn-outline-light me-2" (click)="toggleFullscreen()" [title]="isFullscreen ? 'Salir de pantalla completa' : 'Pantalla completa'">
        <i class="bi" [ngClass]="isFullscreen ? 'bi-fullscreen-exit' : 'bi-fullscreen'"></i>
      </button>
      <button class="btn btn-sm btn-outline-light me-2" (click)="saveChanges()" [disabled]="flowNodes.length === 0">
        <i class="bi bi-save me-1"></i> Guardar
      </button>
      <button class="btn btn-sm btn-outline-light" (click)="cancelEditing()">
        <i class="bi bi-x-circle me-1"></i> Cancelar
      </button>
    </div>
  </div>

  <!-- Canvas principal (ocupa toda la pantalla) -->
  <div class="main-canvas-container">
    <!-- Controles de zoom flotantes -->
    <div class="floating-controls">
      <div class="btn-group-vertical">
        <button class="btn btn-sm btn-dark" (click)="zoomIn()" title="Acercar (Ctrl++)">
          <i class="bi bi-zoom-in"></i>
        </button>
        <button class="btn btn-sm btn-dark" (click)="resetZoom()" title="Restablecer zoom (Ctrl+0)">
          <i class="bi bi-aspect-ratio"></i>
        </button>
        <button class="btn btn-sm btn-dark" (click)="zoomOut()" title="Alejar (Ctrl+-)">
          <i class="bi bi-zoom-out"></i>
        </button>
        <button class="btn btn-sm btn-dark" (click)="centerCanvas()" title="Centrar flujo (Ctrl+H)">
          <i class="bi bi-arrows-fullscreen"></i>
        </button>
        <button class="btn btn-sm btn-dark" (click)="toggleGrid()" title="Mostrar/ocultar cuadrícula (Ctrl+G)">
          <i class="bi bi-grid-3x3"></i>
        </button>
        <button class="btn btn-sm btn-dark" (click)="toggleDarkMode()" title="Cambiar tema (Ctrl+D)">
          <i class="bi" [ngClass]="isDarkMode ? 'bi-sun' : 'bi-moon'"></i>
        </button>
      </div>
      <div class="zoom-info">
        {{(zoomLevel * 100).toFixed(0)}}%
      </div>
    </div>

    <!-- Canvas de edición -->
    <div class="flow-canvas"
         [ngClass]="{'dark-mode': isDarkMode, 'light-mode': !isDarkMode, 'grid-visible': showGrid}"
         [style.height]="canvasHeight"
         (dragover)="onCanvasDragOver($event)"
         (drop)="onCanvasDrop($event)"
         (mousedown)="startPanning($event)"
         (mousemove)="doPanning($event)"
         (mouseup)="stopPanning()"
         (mouseleave)="stopPanning()">
      
      <!-- Contenedor con zoom -->
      <div class="zoom-container" 
           [style.transform]="'scale(' + zoomLevel + ')'"
           [style.transform-origin]="'top left'"
           [style.margin-left.px]="panOffsetX"
           [style.margin-top.px]="panOffsetY">
        
        <!-- Mensaje cuando no hay targetContext -->
        <div *ngIf="targetContainers.length === 0" class="empty-flow-message">
          <div class="text-center">
            <i class="bi bi-bullseye display-4 text-muted mb-3"></i>
            <h5 class="text-muted">No hay Target Context definido</h5>
            <p class="text-muted small">El flujo no contiene información de Target Context</p>
            <p class="text-muted small mt-2">
              <i class="bi bi-info-circle me-1"></i>
              Abre el panel izquierdo para seleccionar controles SAP
            </p>
          </div>
        </div>
        
        <!-- Flechas de conexión entre contenedores -->
        <svg class="container-connections-layer" 
             style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; pointer-events: none; z-index: 1;">
          <path *ngFor="let conn of containerConnections" 
                [attr.d]="getPathForContainerConnection(conn.sourceId, conn.targetId)"
                class="container-connection-path"
                stroke="#0d6efd"
                stroke-width="3"
                fill="none"
                marker-end="url(#container-arrowhead)">
          </path>
          
          <!-- Definición de marcadores para las flechas -->
          <defs>
            <marker id="container-arrowhead" 
                    markerWidth="10" 
                    markerHeight="7" 
                    refX="9" 
                    refY="3.5" 
                    orient="auto">
              <polygon points="0 0, 10 3.5, 0 7" fill="#0d6efd" />
            </marker>
          </defs>
        </svg>
        
        <!-- Contenedores de Targets -->
        <div *ngFor="let container of targetContainers" 
             class="target-container"
             [class.selected]="selectedContainer?.id === container.id"
             [ngClass]="container.colorClass"
             [style.left.px]="container.x" 
             [style.top.px]="container.y"
             [style.width.px]="container.width"
             [style.height.px]="container.height"
             draggable="true"
             (dragstart)="onContainerDragStart($event, container)"
             (click)="selectContainer(container)">
          
          <!-- Botón de eliminar contenedor (flotante) -->
          <button class="container-delete-btn" 
                  [title]="container.friendlyName + ' (' + container.fullKey + ')'"
                  (click)="deleteContainer(container.id); $event.stopPropagation()">
            <span>×</span>
          </button>
          
          <!-- Controles dentro del contenedor -->
          <div class="target-container-body">
            <div *ngFor="let control of container.controls" 
                 class="control-node" 
                 [class.selected]="selectedTargetContextNode?.id === control.id"
                 [style.left.px]="control.x - container.x" 
                 [style.top.px]="control.y - container.y"
                 draggable="true"
                 (dragstart)="onNodeDragStart($event, control)"
                 (click)="selectTargetContextNode(control); $event.stopPropagation()">
              <div class="control-node-header">
                <i class="bi me-1" [ngClass]="getControlIcon(control.data?.controlType || '')"></i>
                <span class="control-label">{{control.label}}</span>
                <button *ngIf="selectedTargetContextNode?.id === control.id" 
                        class="btn btn-sm btn-close ms-auto p-0" 
                        (click)="deleteControlFromContainer(control, container); $event.stopPropagation()">
                </button>
              </div>
              <div class="control-node-content">
                <div class="text-center small">
                  <div *ngIf="control.data?.controlType" class="mb-1">
                    <span class="badge bg-secondary small">{{control.data.controlType}}</span>
                  </div>
                  <div *ngIf="control.data?.target" class="text-truncate" style="max-width: 150px;" title="{{control.data.target}}">
                    <i class="bi bi-cursor me-1"></i> {{control.data.target}}
                  </div>
                  <div *ngIf="control.data?.action" class="mt-1">
                    <span class="badge" [ngClass]="{
                      'bg-success': control.data.action === 'click',
                      'bg-primary': control.data.action === 'set',
                      'bg-warning text-dark': control.data.action === 'callProgram'
                    }">{{control.data.action}}</span>
                  </div>
                  
                  <!-- Mostrar próximo paso -->
                  <div *ngIf="node.data?.next" class="text-truncate small text-muted mt-1" style="max-width: 150px;">
                    <i class="bi bi-arrow-right me-1"></i> {{node.data.next}}
                  </div>
                  
                  <!-- Indicador de sub-acciones -->
                  <div *ngIf="hasSubActions(node)" class="mt-2">
                    <div class="d-flex flex-wrap gap-1">
                      <span *ngFor="let subAction of getSubActionNames(node)" 
                            class="badge bg-light text-dark small"
                            title="Sub-acción: {{subAction}}">
                        {{subAction}}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Botones flotantes para abrir paneles -->
  <button class="floating-panel-toggle left" 
          [class.active]="showLeftPanel"
          (click)="showLeftPanel = !showLeftPanel"
          title="Abrir/Cerrar Panel de Controles SAP">
    <i class="bi" [ngClass]="showLeftPanel ? 'bi-chevron-left' : 'bi-chevron-right'"></i>
  </button>

  <!-- Panel izquierdo flotante (Controles SAP) -->
  <div class="floating-panel left-panel" 
       [class.open]="showLeftPanel"
       [style.width.px]="leftPanelWidth">
    <div class="panel-header">
      <h6 class="mb-0">
        <i class="bi bi-sliders me-2"></i>
        Controles SAP
      </h6>
      <button class="btn btn-sm btn-close" (click)="showLeftPanel = false"></button>
    </div>
    <div class="panel-content">
      <!-- Acciones de Flujo -->
      <div class="accordion-section mb-3">
        <div class="accordion-header d-flex align-items-center justify-content-between p-2 rounded bg-light cursor-pointer" 
             (click)="toggleAccordion('buttons')">
          <span class="fw-medium">Acciones de Flujo</span>
          <i class="bi" [ngClass]="accordionState['buttons'] ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
        </div>
        <div class="accordion-body" [ngClass]="{'show': accordionState['buttons']}">
          <div class="d-grid gap-2">
            <button class="btn btn-sm btn-outline-primary" (click)="viewFullJson()" [disabled]="targetContainers.length === 0">
              <i class="bi bi-code-slash me-1"></i> Ver JSON
            </button>
            <button class="btn btn-sm btn-outline-secondary" (click)="autoArrangeNodes()" [disabled]="flowNodes.length === 0">
              <i class="bi bi-grid-3x3 me-1"></i> Organizar Flujo
            </button>
          </div>
        </div>
      </div>

      <!-- Controles SAP -->
      <div class="accordion-section mb-3">
        <div class="accordion-header d-flex align-items-center justify-content-between p-2 rounded bg-light cursor-pointer" 
             (click)="toggleAccordion('sapControls')">
          <span class="fw-medium"><i class="bi bi-sliders me-1"></i> Controles SAP</span>
          <i class="bi" [ngClass]="accordionState['sapControls'] ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
        </div>
        <div class="accordion-body" [ngClass]="{'show': accordionState['sapControls']}">
          <div *ngIf="loadingTargets" class="text-center py-3">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="small text-muted mt-2 mb-0">Cargando targets desde SFTP...</p>
          </div>
          
          <div *ngIf="!loadingTargets && !currentFlowFileName" class="text-center text-muted small py-2">
            <i class="bi bi-info-circle me-1"></i>
            Carga un flujo para ver los Target Context disponibles.
          </div>
          
          <div *ngIf="!loadingTargets && currentFlowFileName && availableTargets.length === 0" class="text-center text-muted small py-2">
            <i class="bi bi-info-circle me-1"></i>
            No se encontraron Target Context para este flujo.
            <br>
            <small>Directorio: ~/lek-files/can/sap-config/sap-gui-flow/sap-targets$</small>
          </div>
          
          <div *ngIf="!loadingTargets && currentFlowFileName && availableTargets.length > 0">
            <div class="mb-2">
              <label class="form-label small fw-medium">Seleccionar Target Context:</label>
              <select class="form-select form-select-sm" 
                      [(ngModel)]="selectedTargetContext"
                      (change)="selectTargetContextForControls(selectedTargetContext!)">
                <option [value]="null">-- Seleccione un contexto --</option>
                <option *ngFor="let context of getAvailableTargetContexts()" 
                        [value]="context.key"
                        [title]="getTargetContextTooltip(context)">
                  {{ context.friendlyName }}
                </option>
              </select>
            </div>
            
            <div *ngIf="selectedTargetContext">
              <div *ngIf="loadingControls" class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="small text-muted mt-2 mb-0">Cargando controles...</p>
              </div>
              
              <div *ngIf="!loadingControls && targetContextControls.length === 0" class="text-center text-muted small py-2">
                <i class="bi bi-inbox me-1"></i>
                No se encontraron controles manipulables
              </div>
              
              <div *ngIf="!loadingControls && targetContextControls.length > 0">
                <!-- Campo de búsqueda -->
                <div class="input-group input-group-sm mb-2">
                  <input type="text" 
                         class="form-control" 
                         placeholder="Buscar control..." 
                         [(ngModel)]="controlSearchTerm" 
                         (input)="filterControls()">
                  <button class="btn btn-outline-secondary" 
                          type="button" 
                          (click)="controlSearchTerm = ''; filterControls()"
                          *ngIf="controlSearchTerm">
                    <i class="bi bi-x"></i>
                  </button>
                  <button class="btn btn-outline-secondary" 
                          type="button" 
                          (click)="filterControls()">
                    <i class="bi bi-search"></i>
                  </button>
                </div>
                
                <!-- Filtro por tipo de control -->
                <div class="mb-2" *ngIf="availableControlTypes.length > 0">
                  <label class="form-label small fw-medium mb-1">
                    <i class="bi bi-funnel me-1"></i>Filtrar por tipo:
                  </label>
                  <div class="d-flex flex-wrap gap-2">
                    <button *ngFor="let type of availableControlTypes" 
                            type="button"
                            class="btn btn-sm"
                            [class.btn-primary]="selectedControlTypes.includes(type)"
                            [class.btn-outline-secondary]="!selectedControlTypes.includes(type)"
                            (click)="toggleControlTypeFilter(type)">
                      {{ type }}
                    </button>
                    <button *ngIf="selectedControlTypes.length > 0"
                            type="button"
                            class="btn btn-sm btn-outline-danger"
                            (click)="clearControlTypeFilter()">
                      <i class="bi bi-x-circle me-1"></i>Limpiar
                    </button>
                  </div>
                </div>
                
                <div class="small text-muted mb-2">
                  <i class="bi bi-list-check me-1"></i>
                  <span *ngIf="controlSearchTerm || selectedControlTypes.length > 0">
                    {{ filteredTargetContextControls.length }} de {{ targetContextControls.length }} control(es)
                  </span>
                  <span *ngIf="!controlSearchTerm && selectedControlTypes.length === 0">
                    {{ targetContextControls.length }} control(es) disponible(s)
                  </span>
                </div>
                
                <div *ngIf="filteredTargetContextControls.length === 0 && (controlSearchTerm || selectedControlTypes.length > 0)" class="text-center text-muted small py-3">
                  <i class="bi bi-search me-1"></i>
                  <span *ngIf="controlSearchTerm && selectedControlTypes.length > 0">
                    No se encontraron controles que coincidan con "{{ controlSearchTerm }}" y los tipos seleccionados
                  </span>
                  <span *ngIf="controlSearchTerm && selectedControlTypes.length === 0">
                    No se encontraron controles que coincidan con "{{ controlSearchTerm }}"
                  </span>
                  <span *ngIf="!controlSearchTerm && selectedControlTypes.length > 0">
                    No se encontraron controles de los tipos seleccionados
                  </span>
                </div>
                
                <div *ngIf="filteredTargetContextControls.length > 0" class="controls-list">
                  <div class="list-group list-group-flush">
                    <div *ngFor="let control of filteredTargetContextControls" 
                         class="list-group-item list-group-item-action p-2 small"
                         style="cursor: pointer; border: 1px solid #dee2e6; border-radius: 4px; margin-bottom: 4px;"
                         (click)="selectControl(control)"
                         title="{{ control.path }}">
                      <div class="d-flex align-items-center">
                        <i class="bi me-2" [ngClass]="getControlIcon(control.controlType)"></i>
                        <div class="flex-grow-1">
                          <div class="fw-medium">{{ control.friendlyName }}</div>
                          <div class="text-muted" style="font-size: 10px;">
                            <span class="badge bg-secondary me-1">{{ control.controlType }}</span>
                            <span class="text-truncate d-inline-block" style="max-width: 150px;">{{ control.name }}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para ver el JSON completo -->
<div class="modal" [class.show]="isEditing" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-backdrop" *ngIf="isEditing" (click)="cancelEditing()"></div>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-white" *ngIf="isEditing">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-code-square me-2"></i>
          JSON del Target Context
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="cancelEditing()"></button>
      </div>
      <div class="modal-body p-0">
        <div class="json-editor-container">
          <pre class="json-viewer">{{flowCode}}</pre>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-light" (click)="cancelEditing()">Cerrar</button>
      </div>
    </div>
  </div>
</div>
