<!-- Contenedor principal estilo Figma -->
<div class="figma-editor-container" [class.fullscreen-mode]="isFullscreen">
  <!-- Barra de herramientas superior flotante -->
  <div class="floating-toolbar">
    <div class="toolbar-left">
      <h5 class="toolbar-title mb-0">
        <i class="bi bi-diagram-3 me-2"></i>
        Editor de Flujo SAP
      </h5>
    </div>
    <div class="toolbar-right">
      <button class="btn btn-sm btn-outline-light me-2" (click)="toggleFullscreen()" [title]="isFullscreen ? 'Salir de pantalla completa' : 'Pantalla completa'">
        <i class="bi" [ngClass]="isFullscreen ? 'bi-fullscreen-exit' : 'bi-fullscreen'"></i>
      </button>
      <button class="btn btn-sm btn-outline-light me-2" (click)="toggleTargetsJsonModal()" [title]="'Previsualizar JSON de targets'">
        <i class="bi bi-filetype-json"></i>
        Targets JSON
      </button>
      <button class="btn btn-sm btn-outline-light me-2" (click)="toggleDebugPanel()" [class.active]="showDebugPanel" [title]="showDebugPanel ? 'Ocultar panel de debugging' : 'Mostrar panel de debugging'">
        <i class="bi" [ngClass]="showDebugPanel ? 'bi-bug-fill' : 'bi-bug'"></i>
        <span *ngIf="validationResult && !validationResult.isValid" class="badge bg-danger ms-1">{{ validationResult.errors.length }}</span>
      </button>
      <button class="btn btn-sm btn-outline-light me-2" (click)="saveChanges()" [disabled]="flowNodes.length === 0">
        <i class="bi bi-save me-1"></i> Guardar
      </button>
      <button class="btn btn-sm btn-outline-light" (click)="cancelEditing()">
        <i class="bi bi-x-circle me-1"></i> Cancelar
      </button>
    </div>
  </div>

  <!-- Canvas principal (ocupa toda la pantalla) -->
  <div class="main-canvas-container">
    <!-- Controles de zoom flotantes -->
    <div class="floating-controls">
      <div class="btn-group-vertical">
        <button class="btn btn-sm btn-dark" (click)="zoomIn()" title="Acercar (Ctrl++)">
          <i class="bi bi-zoom-in"></i>
        </button>
        <button class="btn btn-sm btn-dark" (click)="resetZoom()" title="Restablecer zoom (Ctrl+0)">
          <i class="bi bi-aspect-ratio"></i>
        </button>
        <button class="btn btn-sm btn-dark" (click)="zoomOut()" title="Alejar (Ctrl+-)">
          <i class="bi bi-zoom-out"></i>
        </button>
        <button class="btn btn-sm btn-dark" (click)="centerCanvas()" title="Centrar flujo (Ctrl+H)">
          <i class="bi bi-arrows-fullscreen"></i>
        </button>
        <button class="btn btn-sm btn-dark" (click)="toggleGrid()" title="Mostrar/ocultar cuadrícula (Ctrl+G)">
          <i class="bi bi-grid-3x3"></i>
        </button>
        <button class="btn btn-sm btn-dark" (click)="toggleDarkMode()" title="Cambiar tema (Ctrl+D)">
          <i class="bi" [ngClass]="isDarkMode ? 'bi-sun' : 'bi-moon'"></i>
        </button>
      </div>
      <div class="zoom-info">
        {{(zoomLevel * 100).toFixed(0)}}%
      </div>
    </div>

    <!-- Canvas de edición -->
    <div class="flow-canvas"
         [ngClass]="{'dark-mode': isDarkMode, 'light-mode': !isDarkMode, 'grid-visible': showGrid}"
         [style.height]="canvasHeight"
         (dragover)="onCanvasDragOver($event)"
         (drop)="onCanvasDrop($event)"
         (mousedown)="startPanning($event)"
         (mousemove)="doPanning($event)"
         (mouseup)="stopPanning()"
         (mouseleave)="stopPanning()">
      
      <!-- Contenedor con zoom -->
      <div class="zoom-container" 
           [style.transform]="'scale(' + zoomLevel + ')'"
           [style.transform-origin]="'top left'"
           [style.margin-left.px]="panOffsetX"
           [style.margin-top.px]="panOffsetY">
        
        <!-- Mensaje cuando no hay targetContext -->
        <div *ngIf="targetContainers.length === 0" class="empty-flow-message">
          <div class="text-center">
            <i class="bi bi-bullseye display-4 text-muted mb-3"></i>
            <h5 class="text-muted">No hay Target Context definido</h5>
            <p class="text-muted small">El flujo no contiene información de Target Context</p>
            <p class="text-muted small mt-2">
              <i class="bi bi-info-circle me-1"></i>
              Abre el panel izquierdo para seleccionar controles SAP
            </p>
          </div>
        </div>
        
        <!-- Flechas de conexión entre contenedores -->
        <svg class="container-connections-layer" 
             [attr.width]="10000"
             [attr.height]="10000"
             style="position: absolute; top: 0; left: 0; pointer-events: none; z-index: 6; overflow: visible;">
          <defs>
            <!-- Definición de marcadores para las flechas -->
            <marker id="container-arrowhead" 
                    markerWidth="12" 
                    markerHeight="10" 
                    refX="10" 
                    refY="5" 
                    orient="auto"
                    markerUnits="userSpaceOnUse">
              <polygon points="0 0, 12 5, 0 10" fill="#0d6efd" stroke="#0d6efd" stroke-width="1" />
            </marker>
          </defs>
          <path *ngFor="let conn of containerConnections; trackBy: trackByConnection" 
                [attr.d]="getPathForContainerConnection(conn.sourceId, conn.targetId)"
                class="container-connection-path"
                stroke="#0d6efd"
                stroke-width="4"
                fill="none"
                marker-end="url(#container-arrowhead)">
          </path>
        </svg>
        
        <!-- Contenedores de Targets -->
        <div *ngFor="let container of targetContainers" 
             class="target-container"
             [class.selected]="selectedContainer?.id === container.id"
             [class.dragging]="draggedContainer?.id === container.id"
             [class.drag-over-container]="dragOverContainer?.id === container.id && draggedContainer?.id !== container.id"
             [class.has-errors]="hasContainerErrors(container.fullKey)"
             [ngClass]="container.colorClass"
             [style.left.px]="container.x" 
             [style.top.px]="container.y"
             [style.width.px]="container.width"
             [style.height.px]="container.height"
             (click)="selectContainer(container)">
          
          <!-- Header del contenedor (solo el header es draggable para mover el contenedor) -->
          <div class="target-container-header"
               draggable="true"
               (dragstart)="onContainerDragStart($event, container)"
               (dragover)="onContainerDragOver($event, container)"
               (dragleave)="onContainerDragLeave($event)"
               (drop)="onContainerDrop($event, container)"
               (click)="$event.stopPropagation()">
            <span class="container-title">{{container.friendlyName || container.fullKey || container.targetContextKey}}</span>
            <span class="container-key" *ngIf="container.fullKey && container.fullKey !== container.friendlyName">({{container.fullKey}})</span>
            <!-- Indicador de errores -->
            <span *ngIf="hasContainerErrors(container.fullKey)" 
                  class="badge bg-danger ms-2" 
                  [title]="getContainerErrors(container.fullKey).join('\n')">
              <i class="bi bi-exclamation-triangle"></i> {{ getContainerErrors(container.fullKey).length }}
            </span>
          </div>
          
          <!-- Botón de eliminar contenedor (flotante) -->
          <button class="container-delete-btn" 
                  [title]="container.friendlyName + ' (' + container.fullKey + ')'"
                  (click)="deleteContainer(container.id); $event.stopPropagation()">
            <span>×</span>
          </button>
          
          <!-- Controles dentro del contenedor -->
          <div class="target-container-body"
               (dragover)="onContainerBodyDragOver($event, container)"
               (drop)="onContainerBodyDrop($event, container)"
               (dragenter)="onContainerBodyDragEnter($event, container)"
               (dragleave)="onContainerBodyDragLeave($event)">
            <div *ngFor="let control of container.controls; let i = index" 
                 class="control-node" 
                 [class.selected]="selectedTargetContextNode?.id === control.id"
                 [class.dragging]="draggedControl?.id === control.id"
                 [class.drag-over]="dragOverControl?.id === control.id && draggedControlContainer?.id === container.id"
                 [style.left.px]="control.x - container.x" 
                 [style.top.px]="control.y - container.y"
                 draggable="true"
                 (dragstart)="onControlDragStart($event, control, container)"
                 (dragover)="onControlDragOver($event, control, container, i)"
                 (dragleave)="onControlDragLeave($event)"
                 (drop)="onControlDrop($event, control, container, i)"
                 (click)="selectTargetContextNode(control); $event.stopPropagation()">
              <div class="control-node-header">
                <i class="bi me-1" [ngClass]="getControlIcon(control.data?.controlType || '')"></i>
                <span class="control-label">{{control.label}}</span>
                <button *ngIf="selectedTargetContextNode?.id === control.id" 
                        class="btn btn-sm btn-close ms-auto p-0" 
                        (click)="deleteControlFromContainer(control, container); $event.stopPropagation()">
                </button>
              </div>
              <div class="control-node-content">
                <div class="text-center small">
                  <div *ngIf="control.data?.controlType" class="mb-1">
                    <span class="badge bg-secondary small">{{control.data.controlType}}</span>
                  </div>
                  <div *ngIf="control.data?.target" class="text-truncate" style="max-width: 150px;" title="{{control.data.target}}">
                    <i class="bi bi-cursor me-1"></i> {{control.data.target}}
                  </div>
                  <div *ngIf="control.data?.action" class="mt-1">
                    <span class="badge" [ngClass]="{
                      'bg-success': control.data.action === 'click',
                      'bg-primary': control.data.action === 'set',
                      'bg-warning text-dark': control.data.action === 'callProgram'
                    }">{{control.data.action}}</span>
                  </div>
                  
                  <!-- Mostrar próximo paso -->
                  <div *ngIf="control.data?.next" class="text-truncate small text-muted mt-1" style="max-width: 150px;">
                    <i class="bi bi-arrow-right me-1"></i> {{control.data.next}}
                  </div>
                  
                  <!-- Indicador de sub-acciones -->
                  <div *ngIf="hasSubActions(control)" class="mt-2">
                    <div class="d-flex flex-wrap gap-1">
                      <span *ngFor="let subAction of getSubActionNames(control)" 
                            class="badge bg-light text-dark small"
                            title="Sub-acción: {{subAction}}">
                        {{subAction}}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Botones flotantes para abrir paneles -->
  <button class="floating-panel-toggle left" 
          [class.active]="showLeftPanel"
          (click)="showLeftPanel = !showLeftPanel"
          title="Abrir/Cerrar Panel de Controles SAP">
    <i class="bi" [ngClass]="showLeftPanel ? 'bi-chevron-left' : 'bi-chevron-right'"></i>
  </button>

  <!-- Panel izquierdo flotante (Controles SAP) -->
  <div class="floating-panel left-panel" 
       [class.open]="showLeftPanel"
       [style.width.px]="leftPanelWidth">
    <div class="panel-header">
      <h6 class="mb-0">
        <i class="bi bi-sliders me-2"></i>
        Controles SAP
      </h6>
      <button class="btn btn-sm btn-close" (click)="showLeftPanel = false"></button>
    </div>
    <div class="panel-content">
      <!-- Acciones de Flujo -->
      <div class="accordion-section mb-3">
        <div class="accordion-header d-flex align-items-center justify-content-between p-2 rounded bg-light cursor-pointer" 
             (click)="toggleAccordion('buttons')">
          <span class="fw-medium">Acciones de Flujo</span>
          <i class="bi" [ngClass]="accordionState['buttons'] ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
        </div>
        <div class="accordion-body" [ngClass]="{'show': accordionState['buttons']}">
          <div class="d-grid gap-2">
            <button class="btn btn-sm btn-outline-primary" (click)="viewFullJson()" [disabled]="!flowData && !targetContextData">
              <i class="bi bi-code-slash me-1"></i> Editar JSON Completo
            </button>
            <button class="btn btn-sm btn-outline-secondary" (click)="autoArrangeNodes()" [disabled]="flowNodes.length === 0">
              <i class="bi bi-grid-3x3 me-1"></i> Organizar Flujo
            </button>
          </div>
        </div>
      </div>

      <!-- Controles SAP -->
      <div class="accordion-section mb-3">
        <div class="accordion-header d-flex align-items-center justify-content-between p-2 rounded bg-light cursor-pointer" 
             (click)="toggleAccordion('sapControls')">
          <span class="fw-medium"><i class="bi bi-sliders me-1"></i> Controles SAP</span>
          <i class="bi" [ngClass]="accordionState['sapControls'] ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
        </div>
        <div class="accordion-body" [ngClass]="{'show': accordionState['sapControls']}">
          <div *ngIf="loadingTargets" class="text-center py-3">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="small text-muted mt-2 mb-0">Cargando targets desde SFTP...</p>
          </div>
          
          <div *ngIf="!loadingTargets && !currentFlowFileName" class="text-center text-muted small py-2">
            <i class="bi bi-info-circle me-1"></i>
            Carga un flujo para ver los Target Context disponibles.
          </div>
          
          <div *ngIf="!loadingTargets && currentFlowFileName && availableTargets.length === 0" class="text-center text-muted small py-2">
            <i class="bi bi-info-circle me-1"></i>
            No se encontraron Target Context para este flujo.
            <br>
            <small>Directorio: ~/lek-files-dev/can/sap-config/sap-gui-flow/sap-targets$</small>
          </div>
          
          <div *ngIf="!loadingTargets && currentFlowFileName && availableTargets.length > 0">
            <div class="mb-2">
              <label class="form-label small fw-medium">Seleccionar Target Context:</label>
              <select class="form-select form-select-sm" 
                      [(ngModel)]="selectedTargetContext"
                      (change)="selectTargetContextForControls(selectedTargetContext!)">
                <option [value]="null">-- Seleccione un contexto --</option>
                <option *ngFor="let context of getAvailableTargetContexts()" 
                        [value]="context.key"
                        [title]="getTargetContextTooltip(context)">
                  {{ context.friendlyName }}
                </option>
              </select>
            </div>
            
            <div *ngIf="selectedTargetContext">
              <div *ngIf="loadingControls" class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="small text-muted mt-2 mb-0">Cargando controles...</p>
              </div>
              
              <div *ngIf="!loadingControls && targetContextControls.length === 0" class="text-center text-muted small py-2">
                <i class="bi bi-inbox me-1"></i>
                No se encontraron controles
              </div>
              
              <div *ngIf="!loadingControls && targetContextControls.length > 0">
                <!-- Campo de búsqueda -->
                <div class="input-group input-group-sm mb-2">
                  <input type="text" 
                         class="form-control" 
                         placeholder="Buscar control..." 
                         [(ngModel)]="controlSearchTerm" 
                         (input)="filterControls()">
                  <button class="btn btn-outline-secondary" 
                          type="button" 
                          (click)="controlSearchTerm = ''; filterControls()"
                          *ngIf="controlSearchTerm">
                    <i class="bi bi-x"></i>
                  </button>
                  <button class="btn btn-outline-secondary" 
                          type="button" 
                          (click)="filterControls()">
                    <i class="bi bi-search"></i>
                  </button>
                </div>
                
                <!-- Filtro por tipo de control -->
                <div class="mb-2" *ngIf="availableControlTypes.length > 0">
                  <label class="form-label small fw-medium mb-1">
                    <i class="bi bi-funnel me-1"></i>Filtrar por tipo:
                  </label>
                  <div class="d-flex flex-wrap gap-2">
                    <button *ngFor="let type of availableControlTypes" 
                            type="button"
                            class="btn btn-sm"
                            [class.btn-primary]="selectedControlTypes.includes(type)"
                            [class.btn-outline-secondary]="!selectedControlTypes.includes(type)"
                            (click)="toggleControlTypeFilter(type)">
                      {{ type }}
                    </button>
                    <button *ngIf="selectedControlTypes.length > 0"
                            type="button"
                            class="btn btn-sm btn-outline-danger"
                            (click)="clearControlTypeFilter()">
                      <i class="bi bi-x-circle me-1"></i>Limpiar
                    </button>
                  </div>
                </div>
                
                <div class="small text-muted mb-2">
                  <i class="bi bi-list-check me-1"></i>
                  <span *ngIf="controlSearchTerm || selectedControlTypes.length > 0">
                    {{ filteredTargetContextControls.length }} de {{ targetContextControls.length }} control(es)
                  </span>
                  <span *ngIf="!controlSearchTerm && selectedControlTypes.length === 0">
                    {{ targetContextControls.length }} control(es) disponible(s)
                  </span>
                </div>
                
                <div *ngIf="filteredTargetContextControls.length === 0 && (controlSearchTerm || selectedControlTypes.length > 0)" class="text-center text-muted small py-3">
                  <i class="bi bi-search me-1"></i>
                  <span *ngIf="controlSearchTerm && selectedControlTypes.length > 0">
                    No se encontraron controles que coincidan con "{{ controlSearchTerm }}" y los tipos seleccionados
                  </span>
                  <span *ngIf="controlSearchTerm && selectedControlTypes.length === 0">
                    No se encontraron controles que coincidan con "{{ controlSearchTerm }}"
                  </span>
                  <span *ngIf="!controlSearchTerm && selectedControlTypes.length > 0">
                    No se encontraron controles de los tipos seleccionados
                  </span>
                </div>
                
                <div *ngIf="filteredTargetContextControls.length > 0" class="controls-list">
                  <div class="list-group list-group-flush">
                    <div *ngFor="let control of filteredTargetContextControls" 
                         class="list-group-item list-group-item-action p-2 small"
                         style="cursor: pointer; border: 1px solid #dee2e6; border-radius: 4px; margin-bottom: 4px;"
                         (click)="selectControl(control)"
                         title="{{ control.path }}">
                      <div class="d-flex align-items-center">
                        <i class="bi me-2" [ngClass]="getControlIcon(control.controlType)"></i>
                        <div class="flex-grow-1">
                          <div class="fw-medium">{{ control.friendlyName }}</div>
                          <div class="text-muted" style="font-size: 10px;">
                            <span class="badge bg-secondary me-1">{{ control.controlType }}</span>
                            <span class="text-truncate d-inline-block" style="max-width: 150px;">{{ control.name }}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para seleccionar T-Code en flujo en blanco -->
<div class="modal" [class.show]="showTcodeSelector" [style.display]="showTcodeSelector ? 'block' : 'none'" [style.z-index]="showTcodeSelector ? '10050' : 'auto'" tabindex="-1" role="dialog" [attr.aria-hidden]="!showTcodeSelector">
  <div class="modal-backdrop" *ngIf="showTcodeSelector" (click)="cancelTcodeSelection()"></div>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white" *ngIf="showTcodeSelector">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-list-ul me-2"></i>
          Seleccionar T-Code
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="cancelTcodeSelection()"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">El flujo está en blanco. Por favor seleccione un T-Code para cargar los targets correspondientes:</p>
        <div class="mb-3">
          <label class="form-label">T-Code:</label>
          <div *ngIf="loadingTcodes" class="text-center py-3">
            <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <span class="text-muted">Cargando T-Codes disponibles...</span>
          </div>
          <select *ngIf="!loadingTcodes" class="form-select bg-dark text-white border-secondary" [(ngModel)]="selectedTcodeForBlankFlow" [disabled]="availableTcodes.length === 0">
            <option value="">-- Seleccione un T-Code --</option>
            <option *ngFor="let tcode of availableTcodes" [value]="tcode">{{ tcode }}</option>
          </select>
          <div *ngIf="!loadingTcodes && availableTcodes.length === 0" class="alert alert-warning mt-2">
            <i class="bi bi-exclamation-triangle me-2"></i>
            No se encontraron archivos de targets disponibles. Verifique la conexión con el servidor SFTP.
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-light" (click)="cancelTcodeSelection()">Cancelar</button>
        <button type="button" class="btn btn-primary" (click)="confirmTcodeSelection()" [disabled]="!selectedTcodeForBlankFlow">
          <i class="bi bi-check-circle me-1"></i> Continuar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para editar el JSON completo -->
<div class="modal" [class.show]="isEditing" [style.display]="isEditing ? 'block' : 'none'" [style.z-index]="isEditing ? '10000' : 'auto'" tabindex="-1" role="dialog" [attr.aria-hidden]="!isEditing">
  <div class="modal-backdrop" *ngIf="isEditing" (click)="cancelEditing()"></div>
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content bg-dark text-white" *ngIf="isEditing">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-code-square me-2"></i>
          Editar JSON del Flujo Completo
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="cancelEditing()"></button>
      </div>
      <div class="modal-body p-0">
        <div class="json-editor-container">
          <textarea 
            class="form-control json-editor" 
            [(ngModel)]="flowCode" 
            rows="25"
            spellcheck="false"
            [placeholder]="getJsonEditorPlaceholder()"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-light" (click)="cancelEditing()">Cancelar</button>
        <button type="button" class="btn btn-primary" (click)="saveEditedJson()" [disabled]="isSaving">
          <span *ngIf="!isSaving">
            <i class="bi bi-save me-1"></i> Guardar cambios
          </span>
          <span *ngIf="isSaving">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Guardando...
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Panel de Debugging y Validación -->
<div class="debug-panel" [class.open]="showDebugPanel" *ngIf="showDebugPanel">
  <div class="debug-panel-header">
    <h5 class="mb-0">
      <i class="bi bi-bug me-2"></i>
      Panel de Debugging y Validación
    </h5>
    <button class="btn btn-sm btn-outline-light" (click)="toggleDebugPanel()">
      <i class="bi bi-x"></i>
    </button>
  </div>
  
  <div class="debug-panel-body">
    <!-- Resumen de estadísticas -->
    <div class="debug-section mb-3">
      <h6 class="text-primary">
        <i class="bi bi-bar-chart me-2"></i>
        Estadísticas del Flujo
      </h6>
      <div class="row g-2">
        <div class="col-6">
          <div class="stat-card">
            <div class="stat-value">{{ getFlowStatistics().containers }}</div>
            <div class="stat-label">Contenedores</div>
          </div>
        </div>
        <div class="col-6">
          <div class="stat-card">
            <div class="stat-value">{{ getFlowStatistics().controls }}</div>
            <div class="stat-label">Controles</div>
          </div>
        </div>
        <div class="col-6">
          <div class="stat-card">
            <div class="stat-value">{{ getFlowStatistics().steps }}</div>
            <div class="stat-label">Steps</div>
          </div>
        </div>
        <div class="col-6">
          <div class="stat-card">
            <div class="stat-value">{{ getFlowStatistics().targetContainers }}</div>
            <div class="stat-label">Contenedores Visuales</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Resultado de validación -->
    <div class="debug-section mb-3" *ngIf="validationResult">
      <h6 [ngClass]="{
        'text-danger': !validationResult.isValid,
        'text-warning': validationResult.isValid && validationResult.warnings.length > 0,
        'text-success': validationResult.isValid && validationResult.warnings.length === 0
      }">
        <i class="bi me-2" [ngClass]="{
          'bi-x-circle': !validationResult.isValid,
          'bi-exclamation-triangle': validationResult.isValid && validationResult.warnings.length > 0,
          'bi-check-circle': validationResult.isValid && validationResult.warnings.length === 0
        }"></i>
        Validación del Flujo
        <span class="badge ms-2" [ngClass]="{
          'bg-danger': !validationResult.isValid,
          'bg-warning': validationResult.isValid && validationResult.warnings.length > 0,
          'bg-success': validationResult.isValid && validationResult.warnings.length === 0
        }">
          {{ validationResult.isValid ? 'Válido' : 'Inválido' }}
        </span>
      </h6>
      
      <!-- Errores -->
      <div *ngIf="validationResult.errors.length > 0" class="alert alert-danger">
        <strong>Errores ({{ validationResult.errors.length }}):</strong>
        <ul class="mb-0 mt-2">
          <li *ngFor="let error of validationResult.errors">
            <span *ngIf="error.container" class="badge bg-secondary me-1">{{ error.container }}</span>
            <span *ngIf="error.step" class="badge bg-info me-1">{{ error.step }}</span>
            {{ error.message }}
          </li>
        </ul>
      </div>
      
      <!-- Advertencias -->
      <div *ngIf="validationResult.warnings.length > 0" class="alert alert-warning">
        <strong>Advertencias ({{ validationResult.warnings.length }}):</strong>
        <ul class="mb-0 mt-2">
          <li *ngFor="let warning of validationResult.warnings.slice(0, 10)">
            <span *ngIf="warning.container" class="badge bg-secondary me-1">{{ warning.container }}</span>
            <span *ngIf="warning.step" class="badge bg-info me-1">{{ warning.step }}</span>
            {{ warning.message }}
          </li>
          <li *ngIf="validationResult.warnings.length > 10" class="text-muted">
            ... y {{ validationResult.warnings.length - 10 }} advertencia(s) más
          </li>
        </ul>
      </div>
      
      <!-- Resumen de validación -->
      <div class="mt-2">
        <small class="text-muted">
          <strong>Resumen:</strong>
          Contenedores: {{ validationResult.summary.totalContainers }},
          Steps: {{ validationResult.summary.totalSteps }},
          Controles: {{ validationResult.summary.totalControls }},
          Conexiones faltantes: {{ validationResult.summary.missingConnections }},
          Nombres duplicados: {{ validationResult.summary.duplicateNames }}
        </small>
      </div>
    </div>
    
    <!-- Vista previa del JSON -->
    <div class="debug-section mb-3">
      <h6 class="text-info">
        <i class="bi bi-code-square me-2"></i>
        Vista Previa del JSON
        <button class="btn btn-sm btn-outline-light ms-2" (click)="jsonPreview = exportFlowToJson()">
          <i class="bi bi-arrow-clockwise"></i> Actualizar
        </button>
      </h6>
      <div class="json-preview-container">
        <pre class="json-preview">{{ jsonPreview || 'No hay JSON para mostrar' }}</pre>
      </div>
    </div>
    
    <!-- Comparación antes/después -->
    <div class="debug-section mb-3" *ngIf="jsonBeforeSave && jsonAfterSave">
      <h6 class="text-warning">
        <i class="bi bi-arrow-left-right me-2"></i>
        Comparación Antes/Después
      </h6>
      <div class="alert alert-info">
        <pre class="mb-0" style="white-space: pre-wrap; font-size: 0.85rem;">{{ compareJsonBeforeAfter() }}</pre>
      </div>
    </div>
    
    <!-- Logs de debugging -->
    <div class="debug-section">
      <h6 class="text-secondary">
        <i class="bi bi-list-ul me-2"></i>
        Logs de Operaciones
        <button class="btn btn-sm btn-outline-light ms-2" (click)="clearDebugLogs()">
          <i class="bi bi-trash"></i> Limpiar
        </button>
        <button class="btn btn-sm btn-outline-light ms-1" (click)="exportDebugLogs()">
          <i class="bi bi-download"></i> Exportar
        </button>
      </h6>
      <div class="debug-logs-container">
        <div *ngFor="let log of debugLogs.slice().reverse().slice(0, 50)" 
             class="debug-log-item"
             [ngClass]="{
               'log-error': log.type === 'error',
               'log-warning': log.type === 'warning',
               'log-info': log.type === 'info'
             }">
          <div class="log-header">
            <span class="log-time">{{ log.timestamp | date:'HH:mm:ss' }}</span>
            <span class="badge ms-2" [ngClass]="{
              'bg-danger': log.type === 'error',
              'bg-warning text-dark': log.type === 'warning',
              'bg-info': log.type === 'info'
            }">{{ log.type.toUpperCase() }}</span>
          </div>
          <div class="log-message">{{ log.message }}</div>
          <div *ngIf="log.data" class="log-data">
            <pre>{{ getLogDataString(log.data) }}</pre>
          </div>
        </div>
        <div *ngIf="debugLogs.length === 0" class="text-muted text-center py-3">
          No hay logs disponibles
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para previsualizar JSON de Targets -->
<div class="modal fade" [class.show]="showTargetsJsonModal" [style.display]="showTargetsJsonModal ? 'block' : 'none'" tabindex="-1" *ngIf="showTargetsJsonModal" [style.background-color]="'rgba(0,0,0,0.5)'">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-bottom border-secondary">
        <h5 class="modal-title text-info">
          <i class="bi bi-file-earmark-code me-2"></i>JSON de Targets Cargados
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="toggleTargetsJsonModal()" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="targetsJsonData; else noTargets" class="json-preview-container">
          <pre class="text-white bg-black p-3 rounded" style="max-height: 70vh; overflow-y: auto; font-size: 12px;">{{ getTargetsJsonString() }}</pre>
        </div>
        <ng-template #noTargets>
          <p class="text-muted text-center py-5">
            <i class="bi bi-info-circle display-4 d-block mb-3"></i>
            No hay datos de targets cargados.
          </p>
        </ng-template>
      </div>
      <div class="modal-footer border-top border-secondary">
        <button type="button" class="btn btn-secondary" (click)="toggleTargetsJsonModal()">Cerrar</button>
        <button type="button" class="btn btn-primary" (click)="copyTargetsJson()" [disabled]="!targetsJsonData">
          <i class="bi bi-clipboard me-1"></i> Copiar JSON
        </button>
      </div>
    </div>
  </div>
</div>
<div *ngIf="showTargetsJsonModal" class="modal-backdrop fade show"></div>
